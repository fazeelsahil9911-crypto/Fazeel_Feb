# Day 25 - Continuous Monitoring and Alerts 

##    Ansible - Setup Prometheus Node Exporter for Monitoring 

'''yaml
- name: Setup Prometheus Node Exporter
  hosts: all
  become: yes
  tasks:
    - name: Install Prometheus Node Exporter
      yum: 
        name: prometheus-node-exporter
        state: present
    - name: Start Prometheus-node-exporter
      service:
        name: prometheus-node-exporter
        state: started
        enabled: yes
  Terraform - Create CloudWatch Alarms 
resource "aws_cloudwatch_metric_alarm" "pathnex_cpu_alarm" {
  alarm_name          = "pathnex-cpu-utilization-high"
  comparison_operator = "GreaterThanThreshold"
  evaluation_periods  = "1"
  metric_name         = "CPUUtilization"
  namespace           = "AWS/EC2?
  period              = "60"
  statistic           = "Average"
  threshold           = "80"

  dimensions = {
    InstanceID = aws_instance.pathnex_ec2.id
  }

  alarm_actions = [aws_sns_topic.pathnex_alerts.arn]
}

resource "aws_sns_topic" "pathnex_alerts" {
  name = "pathnex-alerts"
}
   Kubernetes - Set up Prometheus and Grafana
apiVersion: apps/v1
kind: Deployment 
metadata:
  name: prometheus 
spec:
  replicas: 1
  selector:
    matchLabels:
      app: prometheus 
  template:
    metadata:
      labels:
        app: prometheus 
    spec:
      containers:
        - name: prometheus 
          image: prom/prometheus:latest
          ports:
            - containerPort: 9090
---
apiVersion: apps/v1
kind: Deployment 
metadata:
  name: grafana
spec:
  replicas: 1
  selector:
    matchLabels:
      app: grafana
  template: 
    metadata:
      labels:
        app: grafana
    spec:
      containers:
        - name: grafana
          image: grafana/grafana:latest
          ports:
            - containerPort: 3000
   Jenkinsfile - Continuous Monitoring and Alerts in CI pipeline
pipeline {
    agent any
    stages {
       stage('Monitor') {
           steps {
               script {
                   echo 'Triggering CloudWatch alarms if CPU exceeds 80%'
                   sh 'aws cloudwatch put-metric-data --namespace "AWS/EC2" --metric-name "CPUUtilization" --value 90'  
               }
           }
       }
       stage('Test') {
           steps {
               echo 'Running tests...'
           }
       }
    }
}
   GitLab CI/CD - Monitoring and Alerting in CI/CD Pipeline 
stages:
  - monitor
  - test

monitor:
  stage: monitor
  script:
    - aws cloudwatch put-metric-data --namespace "AWS/EC2" --metric-name "CPUUtilization" --value 90

test:
  stage: test
  script:
    - echo "Running tests..."
